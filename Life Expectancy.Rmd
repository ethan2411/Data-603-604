# DATA 603 Final Project R CODE

This file contains all of our R code for the project. It contains our model building process in the order of these steps:

1.  Building our first/initial model and doing a full F test.

2.  Checking for multicollinearity and removing variables which have a VIF > 5

3.  Reducing the model using the individual t-test. Use partial F-test to confirm the reduced model is significant

4.  Adding interactions to the model and using partial F-test to confirm the interaction model is significant

5.  Reducing the interaction model via stepwise selection

6.  Checking plots between response variable and predictor variables to determine if higher powers need to be present

7.  Adding higher powers and using partial F-test to confirm the higher power model is significant

8.  Checking the assumptions of the final model

9.  Doing various techniques if the model does not meet assumptions (boxcox transformation and removal of outliers)

10. rebuilding the models from the techniques done above and check if the new model meets assumptions better vs the other model.

11. Choosing the best final model within the scope of this course

12. Interpreting beta coefficients

First we loaded in our dataset, removed na values and filtered for only rows that were considered "developing" countries based off of the column Status (states if a row is a devoloped or non-developed country). We filtered for these rows since our project only focuses on developing countries. We also loaded in any libraries we planned on using.

```{r}
library(car)
library(lmtest)
library(GGally)
library(olsrr)
library(MASS)
library(dplyr)
```

```{r}
#read in original csv file and remove na values
LE = read.csv("https://raw.githubusercontent.com/ethan2411/Data-603-604/main/Life%20Expectancy%20Data.csv")
LE = na.omit(LE)
head(LE)
```

```{r}
#select for "developing" rows based on Status column
developing_LE <- LE %>%
  filter(Status == "Developing")
nrow(LE)
nrow(developing_LE)
head(developing_LE)
```

### Building our first/initial model and doing a full F test.

```{r}
options(scipen = 999)
#make first model
develop_firstlm = lm(Life.expectancy ~  Alcohol + Hepatitis.B  + Measles + BMI + Polio + Diphtheria + HIV.AIDS, data = developing_LE)
summary(develop_firstlm)
```

This is our first initial model above. You can also see form the full f test the p-value is <2.2e-16 meaning that at least one of the predictor variables is related to the response variable. 


##Checking for multicollinearity and removing variables which have a VIF > 5

```{r}
#check vif for multicolinnearity to see if we need to drop any variables
vif(develop_firstlm)
#we dont need to drop any so we now reduce model
```
We see from vif that they are all below 5 so we do not have any multicollinearity in our model and so none of the variables need to be removed. 


##Reducing the model using the individual t-test. Use partial F-test to confirm the reduced model is significant

Looking at individual t-test p-values for our initial model above, we see that the p-value for measles is 0.4875. So we fail to reject the null hypothesis and from this we can infer that the variable Measles is not related to the response variable and so can be dropped from the model

We build the reduced model and check to see if we need to drop any other variables.
```{r}
#reduce model via t-test
develop_lmred = lm(Life.expectancy ~  Alcohol + Hepatitis.B + BMI + Polio + Diphtheria + HIV.AIDS, data = developing_LE)
summary(develop_lmred)

#check if reduced model is accepted (it is) via partial f test
anova(develop_firstlm,develop_lmred)
```

We see that all our p-values are less than 0.05, so no more variables need to be dropped from the model. The partial f-test p-value is also 0.4875. From this we can infer that the reduced model is accepted. 

## Adding interactions to the model and using partial F-test to confirm the interaction model is significant

### OLS STEP MODEL

```{r}
#make full interaction model
develop_lmintfull = lm(Life.expectancy ~  (Alcohol + Hepatitis.B + BMI + Polio + Diphtheria + HIV.AIDS)^2, data = developing_LE)
summary(develop_lmintfull)
```



```{r}

#reduce interaction model via ols stepwise because there are too many interactions to do it manually
develop_stepmod_intred = ols_step_both_p(develop_lmintfull, pent= 0.1, prem = 0.3, details = FALSE)
summary(develop_stepmod_intred$model)

```

##Checking plots between response variable and predictor variables to determine if higher powers need to be present

```{r}
#code in the reduced interaction model from stepwise
developing_intred2 = lm(Life.expectancy ~ HIV.AIDS + Hepatitis.B + BMI + Alcohol + Polio + Diphtheria + Polio:Diphtheria +BMI:Polio + Hepatitis.B:Alcohol + HIV.AIDS:Alcohol + Diphtheria:Alcohol +  Hepatitis.B:Polio + HIV.AIDS:Diphtheria, data = developing_LE)

#look for graphs to see if higher order models are required
#ggpairs(developing_intred2)
```


We see that there seems to be some sort of curved relationship with our response variable (life expectancy) and the predictor variable HIV.AIDS. So we now will add a quadratic power to our model and see if the higher power is accepted from the partial F-test


###Adding higher powers and using partial F-test to confirm the higher power model is significant

```{r}
developing_highermod = lm(Life.expectancy ~ HIV.AIDS + I(HIV.AIDS^2) + Hepatitis.B + BMI + Alcohol + Polio + Diphtheria + Polio:Diphtheria +BMI:Polio + Hepatitis.B:Alcohol + HIV.AIDS:Alcohol + Diphtheria:Alcohol +  Hepatitis.B:Polio + HIV.AIDS:Diphtheria, data = developing_LE)

summary(developing_highermod)
#ANOVA TO TEST IF HIGHER ORDER MODEL IS ACCEPTED. IT IS ACCEPTED
anova(developing_highermod, developing_intred2)
```

We see that adding the quadratic power into the model for HIV.AIDS increases the models R squared value from 0.6259 to 0.6796. The partial f-test also accepts the higher order model. For these reasons we have decided to keep the higher order term in our model. We also decided to keep it in our model since we noticed it helps with our linearity assumption (which you will see below). Now we have our final model, now we check the assumptions of the model. 


###Checking the assumptions of the final model

```{r}

#CHECK ASSUMPTIONS OF OUR FINAL MODEL
summary(developing_highermod)
#equal variance assumption
bptest(developing_highermod)

#normality assumption
shapiro.test(residuals(developing_highermod))
#plots to show linearity, equal variance, normality and outlier assumptions
plot(developing_highermod)

```


```{r}
#more plots to show the outlier assumption
lev=hatvalues(developing_highermod)
p = length(coef(developing_highermod))
n = nrow(developing_LE)


par(mfrow = c(1,2))
plot(developing_highermod, which = 4)
plot(rownames(developing_LE),lev, main = "Leverage in Dataset", xlab="observation",
ylab = "Leverage Value")
abline(h = 2 *p/n, lty = 1)
abline(h = 3 *p/n, lty = 1)
```

```{r}
#more plots to show the linearity, equal variance and outliers assumptions

# Residuals vs Fitted Values Plot
ggplot(data.frame(residuals = residuals(developing_highermod), fitted = fitted(developing_highermod)), aes(x = fitted, y = residuals)) +
  geom_point() +
  geom_smooth(method = "loess", se = TRUE, color = "red") +
  labs(title = "Residuals vs Fitted",
       x = "Fitted Values",
       y = "Residuals")

# Scale-Location (Spread-Location) Plot
ggplot(data.frame(fitted = fitted(developing_highermod), std_resid = sqrt(abs(rstandard(developing_highermod)))), aes(x = fitted, y = std_resid)) +
  geom_point() +
  geom_smooth(method = "loess", se = TRUE, color = "red") +
  labs(title = "Scale-Location Plot",
       x = "Fitted Values",
       y = "Square Root of Standardized Residuals")

# Residuals vs Leverage Plot
ggplot(data.frame(hat_values = hatvalues(developing_highermod), std_resid = rstandard(developing_highermod)), aes(x = hat_values, y = std_resid)) +
  geom_point() +
  geom_smooth(method = "loess", se = TRUE, color = "red") +
  labs(title = "Residuals vs Leverage",
       x = "Leverage",
       y = "Standardized Residuals")
```


```{r}
library(patchwork)

# Normal Q-Q Plot
qq_plot <- ggplot(data.frame(std_resid = rstandard(developing_highermod)), aes(sample = std_resid)) +
  geom_qq() +
  geom_qq_line() +
  labs(title = "Normal Q-Q Plot")

# Histogram of Residuals
hist_plot <- ggplot(data = developing_highermod, aes(x = developing_highermod$residuals)) +
  geom_histogram(binwidth = 0.5, fill = 'blue', col = 'red') +
  labs(title = "Histogram of Residuals")+
  xlab("Residuals") +
  ylab("Count")

# Combine plots using patchwork
combined_plot <- qq_plot + hist_plot

# Display the combined plot
combined_plot
```


### Doing various techniques if the model does not meet assumptions (boxcox transformation and removal of outliers)


Since we do not meet the assumption of equal variance, we will do a boxcox transformation to see if it helps meet the assumption. 
=======
### FROM ASSUMPTION CHECKS WE DO BOXCOX
>>>>>>> 0ae5c7f96f25478b7d74ebd15a948aff93d1532f

```{r}
bc = boxcox(developing_highermod, lambda=seq(-1,1))

bestlambda = bc$x[which(bc$y==max(bc$y))]
bestlambda


```

We see from the boxcox transformation that the lambda value it gave us is 1. This tells us that the model does not need any transformations placed upon the response variable. So because of this we do no further steps from the boxcox transformation.


Since we noticed there were outliers with leverage values over 3p/n, we removed these outliers and rebuilt the model in the same order that we built our initial model from above. We then checked the assumptions for this model to compare with the other model. 
```{r}

lev=hatvalues(developing_highermod)
p = length(coef(developing_highermod))
n = nrow(developing_LE)
outlier3p = lev[lev>(3*p/n)]
print("h_I>3p/n, outliers are")
print(outlier3p)

rows_remove3p = which(lev>(3*p/n))
print(rows_remove3p)

developing_LE_no_outliersSTEP = developing_LE[-rows_remove3p, ]
head(developing_LE_no_outliersSTEP)

nrow(developing_LE)
nrow(developing_LE_no_outliersSTEP)
```

```{r}
#make initial model without 3p/n outliers
first3plm= lm(Life.expectancy ~  Alcohol + Hepatitis.B  + Measles + BMI + Polio + Diphtheria + HIV.AIDS, data = developing_LE_no_outliersSTEP)
summary(first3plm)

#reduced model
red3plm = lm(Life.expectancy ~  Alcohol + Hepatitis.B + BMI + Polio + Diphtheria + HIV.AIDS, data = developing_LE_no_outliersSTEP)
summary(red3plm)

#anova accepts the reduced model
anova(first3plm, red3plm)

#int model
int3plm = lm(Life.expectancy ~  (Alcohol + Hepatitis.B + BMI + Polio + Diphtheria + HIV.AIDS)^2, data = developing_LE_no_outliersSTEP)
summary(int3plm)

#anova accepts the interaction model
anova(int3plm, red3plm)

intred3plm = ols_step_both_p(int3plm, pent = 0.1, prem = 0.3, details = FALSE)
summary(intred3plm$model)


```

```{r}

#MAKING REDUCED INT MODEL AFTER STEPWISE
step_red_3p = lm(Life.expectancy ~  HIV.AIDS + Hepatitis.B + Polio + Diphtheria + Alcohol + BMI + BMI:Diphtheria + Diphtheria:Polio + Hepatitis.B:Alcohol + Diphtheria:Alcohol + BMI:Hepatitis.B + BMI:Polio + HIV.AIDS:Polio + Diphtheria:Hepatitis.B, data = developing_LE_no_outliersSTEP)



#CHECK GGPAIRS TO SEE IF WE ADD HIGHER ORDER TO MODEL
#ggpairs(step_red_3p)

#LOOKS LIKE WE DO IT FOR HIV
#make higher order model
higher3plm = lm(Life.expectancy ~ HIV.AIDS + I(HIV.AIDS^2) + Hepatitis.B + Polio + Diphtheria + Alcohol + BMI + BMI:Diphtheria + Diphtheria:Polio + Hepatitis.B:Alcohol + Diphtheria:Alcohol + BMI:Hepatitis.B + BMI:Polio + HIV.AIDS:Polio + Diphtheria:Hepatitis.B, data = developing_LE_no_outliersSTEP)
#stopped at 2. Dont want to create an overfitted model.


#anova accepts higher order model
anova(higher3plm,step_red_3p)
```


Check assumptions of the final model without 3p/n outliers
```{r}
#quick check of assumptions for model without 3p/n outliers
summary(higher3plm)

#equal variance assumption
bptest(higher3plm)

#normality assumption
shapiro.test(residuals(higher3plm))

#check linearity, equal variance, normality and outlier assumptions via plots
plot(higher3plm)

```

### NOW WE ATTEMPT WITH taking out all outliers with leverage above 2p/n from original model TO SEE IF ITS BETTER

NOTE: We kept this section in our documents to show that we attempted a few different ways to help try to meet our model assumptions. However in the end we decided to not compare assumptions with the model without 2p/n outliers. This decision was made because when we looked at the outlier plots for the model without 3p/n outliers we noticed that it was actually creating outliers with higher leverage values than what was previously observed from the original fitted model (model that had no outliers removed). You can see from the model without 3p/n outliers that its residuals vs leverage plot has outliers quite close to cook distance line of 0.5 From this, we were worried that the model without 2p/n outliers would do the same but make the outliers even worse (we were right as seen on its residuals vs leverage plot below sicne there are now influential outliers). We did not want to go down a rabbit hole and constantly have to remove more and more outliers from models, which would cause overfitting in the end. This is what ultimately led to our decision to stop at the model without 3p/n outliers. 



```{r}
lev=hatvalues(developing_highermod)
p = length(coef(developing_highermod))
n = nrow(developing_LE)
outlier2p = lev[lev>(2*p/n)]
print("h_I>2p/n, outliers are")
print(outlier2p)

rows_remove2p = which(lev>(2*p/n))
print(rows_remove2p)

developing_LE_no_outliersSTEP2P = developing_LE[-rows_remove2p, ]
head(developing_LE_no_outliersSTEP2P)

nrow(developing_LE)
nrow(developing_LE_no_outliersSTEP2P)
```

2P FIRST MODEL

```{r}
first2plm= lm(Life.expectancy ~  Alcohol + Hepatitis.B  + Measles + BMI + Polio + Diphtheria + HIV.AIDS, data = developing_LE_no_outliersSTEP2P)
summary(first2plm)
#everything signficiant, so no reductions. make int model next

#int model
int2plm = lm(Life.expectancy ~  (Alcohol + Hepatitis.B  + Measles + BMI + Polio + Diphtheria + HIV.AIDS)^2, data = developing_LE_no_outliersSTEP2P)
summary(int2plm)

#reduced int model via stepwise
intred2plm = ols_step_both_p(int2plm, pent = 0.1, prem = 0.3, details = FALSE)
summary(intred2plm$model)


```


### MAKE HIGHER ORDER 2P MODEL

```{r}

#MAKE NEW MODEL HERE AFTER DOING STEPWISE OLS
step_red_2p = lm(Life.expectancy ~  Alcohol + Hepatitis.B  + Measles + BMI + Polio + Diphtheria + HIV.AIDS, data = developing_LE_no_outliersSTEP2P)


#ggpairs(intred2plm)
#make higher order model
higher2plm = lm(Life.expectancy ~ Alcohol + Hepatitis.B + Measles + BMI + Diphtheria + HIV.AIDS + I(HIV.AIDS^2) + Alcohol:Hepatitis.B + Alcohol:Measles + Alcohol:BMI + Alcohol:Diphtheria + Alcohol:HIV.AIDS + Hepatitis.B:Diphtheria + Measles:Diphtheria + Measles:HIV.AIDS + BMI:Diphtheria + Diphtheria:HIV.AIDS, data = developing_LE_no_outliersSTEP2P)

summary(higher2plm)
bptest(higher2plm)
plot(higher2plm)

shapiro.test(residuals(higher2plm))

#boxcox
bc = boxcox(higher2plm,lambda=seq(-1,1))
bestlambda=bc$x[which(bc$y==max(bc$y))]
bestlambda

```
